@*******************************************************************************************************
    //  ModbusConfig.cshtml - Gbtc
    //
    //  Copyright © 2016, Grid Protection Alliance.  All Rights Reserved.
    //
    //  Licensed to the Grid Protection Alliance (GPA) under one or more contributor license agreements. See
    //  the NOTICE file distributed with this work for additional information regarding copyright ownership.
    //  The GPA licenses this file to you under the MIT License (MIT), the "License"; you may not use this
    //  file except in compliance with the License. You may obtain a copy of the License at:
    //
    //      http://opensource.org/licenses/MIT
    //
    //  Unless agreed to in writing, the subject software distributed under the License is distributed on an
    //  "AS-IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. Refer to the
    //  License for the specific language governing permissions and limitations.
    //
    //  Code Modification History:
    //  ----------------------------------------------------------------------------------------------------
    //  07/08/2016 - J. Ritchie Carroll
    //       Generated original version of source code.
    //
    //*****************************************************************************************************@
@using openMIC.Model
@using RazorEngine.Templating
@inherits TemplateBase<AppModel>
@{
    Layout = "Layout.cshtml";

    const string ReadSequencePanelType = "panel-success";
    const string WriteSequencePanelType = "panel-warning";
}
@section StyleSheets {
    <style>
        /* Show move cursor over sequence panels to indicate drag-drop re-order capability */
        #sequencePanels .panel-heading {
            cursor: move;
            padding-top: 5px;
        }

        form.form-inline-sequence {
            cursor: move;
        }

        form.form-inline-sequence div label {
            cursor: move;
        }

        a.move-sequence-up {
            cursor: pointer;
            position: absolute;
            z-index: 999;
        }

        a.move-sequence-up span {
            cursor: pointer;
            color: darkgray;
            font-weight: bold;
            font-size: 12pt;
            margin-left: 3px;
            top: -12px;
        }

        a.move-sequence-up:hover span {
            color: #0000EE;
        }

        a.move-sequence-down {
            cursor: pointer;
            position: absolute;
            z-index: 999;
        }

        a.move-sequence-down span {
            cursor: pointer;
            color: darkgray;
            font-weight: bold;
            font-size: 12pt;
            margin-left: 3px;
            top: 1px;
        }

        a.move-sequence-down:hover span {
            color: #0000EE;
        }

        @@supports (-ms-accelerator:true) {
            /* Handle adjustments for Microsoft Edge */
            a.move-sequence-up span {
                margin-left: 2px;
            }

            a.move-sequence-down span {
                margin-left: -135px;
                top: 20px;
            }
        }

        @@media all and (-ms-high-contrast:none) {
            /* Handle adjustments for IE 11 */
            a.move-sequence-up span {
                margin-left: 2px;
            }

            a.move-sequence-down span {
                margin-left: -139px;
                top: 20px;
            }
        }

        span.sequence-record-count {
            color: darkgray;
            font-size: 7pt;
            position: absolute;
        }

        @@media screen {
            .sequence-name {
                margin-left: 30px;
                width: calc(100% - 30px);
                width: -o-calc(100% - 30px);
                width: -webkit-calc(100% - 30px);
                width: -moz-calc(100% - 30px);
            }

            span.sequence-record-count {
                margin-top: -15px;
            }

            span.sequence-record-count span {
                margin-left: 155px;
            }
        }

        @@media screen and (min-width: 768px) {
            .sequence-name {
                margin-left: 5px;
                width: 100%;
            }

            span.sequence-record-count {
                margin-top: 3px;
            }

            span.sequence-record-count span {
                margin-left: 45px;
            }
        }

        @@supports (-ms-accelerator:true) {
            /* Handle adjustments for Microsoft Edge */
            span.sequence-record-count {
                margin-top: 3px;
            }

            span.sequence-record-count span {
                margin-left: 15px;
            }
        }

        @@supports (-ms-accelerator:true) and (min-width: 768px) {
            /* Handle adjustments for Microsoft Edge */
            span.sequence-record-count {
                margin-top: 21px;
            }

            span.sequence-record-count span {
                margin-left: -95px;
            }
        }

        @@media all and (-ms-high-contrast:none) {
            /* Handle adjustments for IE 11 */
            span.sequence-record-count {
                margin-top: 3px;
            }

            span.sequence-record-count span {
                margin-left: 15px;
            }
        }

        @@media all and (-ms-high-contrast:none) and (min-width: 768px) {
            /* Handle adjustments for IE 11 */
            span.sequence-record-count {
                margin-top: 21px;
            }

            span.sequence-record-count span {
                margin-left: -95px;
            }
        }

        .panel {
            margin-top: 5px;
            margin-bottom: 5px;
        }

        .panel-body.warning-border {
            border-color: yellow;
            border-style: solid;
        }

        div.warning-message {
            font-size: 9.5pt;
            font-weight: bold;
            text-align: center;
            text-shadow: 1px 1px lightgray;
            margin-top: -10px;
            margin-bottom: 12px;
        }

        div.sequence-records-message {
            font-size: 9pt;
            text-align: center;
            color: darkgray;
            margin-top: -10px;
            margin-bottom: 0;
        }

        span.sequence-group-count {
            position: absolute;
            font-size: 8pt;
            margin-top: 6px;
            margin-left: -36px;
            height: 6px;
            width: 6px;
            -moz-transform: rotate(-90.0deg);
            -o-transform: rotate(-90.0deg);
            -webkit-transform: rotate(-90.0deg);
            -ms-filter: "progid:DXImageTransform.Microsoft.BasicImage(rotation=0.083)";
            filter: progid:DXImageTransform.Microsoft.BasicImage(rotation=0.083);
            transform: rotate(-90.0deg);
        }

        @@media screen and (min-width: 1200px) {
            span.sequence-group-count {
                margin-left: -44px;
            }
        }

        .form-group {
            padding-top: 5px;
        }

        .top-padding {
            padding-top: 5px;
        }

        .top-margin {
            margin-top: 5px;
        }

        .bottom-margin {
            margin-bottom: 5px;
        }

        .connection-status {
            background-color: black;
            padding: 10px;
            margin: 0;
            overflow: auto;
        }

        .glyphicon-interpret-type {
            color: darkgrey;
            vertical-align: middle;
            font-size: 15pt;
            margin-right: -5px;
            margin-left: -5px;
        }

        .glyphicon-interpret-result {
            color: darkgrey;
            vertical-align: middle;
            font-size: 17pt;
        }

        .glyphicon-delete-sequence {
            vertical-align: text-top;
            color: red;
            font-size: larger;
        }

        .glyphicon-action-button {
            color: #606060;
            vertical-align: text-top;
        }

        /*.model-index {
            color: lightgray;
            font-size: 7pt;
            position: relative;
            top: -24px;
            right: -8px;
            margin-left: -8px;
            height: 5px;
            float: right !important;
            opacity: 0.5;
        }*/

        /* Collapsable button style */
        .btn-collapsable.btn {
            color: #606060;
            font-family: "Glyphicons Halflings";
            font-size: 8pt;
            position: relative;
            top: -9px;
            right: -14px;
            padding: 0 2px 2px 2px;
            height: 18px;
            float: right !important;
        }

        /* Collapsable button icon when content is shown - arrow down */
        .btn-collapsable.btn:after {
            content: "\e114";
        }

        /* Collapsable button icon when content is hidden - arrow right */
        .btn-collapsable.btn.collapsed:after {
            content: "\e080";
        }
    </style>
    <!--[if IE]>
    <style type="text/css">
        /* Handle adjustments for older IE versions */
        a.move-sequence-up span {
            margin-left: 2px;
        }

        a.move-sequence-down span {
            margin-left: -139px;
            top: 20px;
        }

        @@media screen
        {
            span.sequence-record-count {
                margin-top: 3px;
            }

            span.sequence-record-count span {
                margin-left: 15px;
            }
        }

        @@media screen and (min-width: 768px)
        {
            span.sequence-record-count {
                margin-top: 21px;
            }

            span.sequence-record-count span {
                margin-left: -95px;
            }
        }
    </style>
    <![endif]-->
}
@section Scripts {
    <script src="Scripts/knockout-3.4.0.js"></script>
    <script src="Scripts/knockout.mapping-latest.js"></script>
    <script src="Scripts/knockout.validation.js"></script>
    <script src="Scripts/ko-reactor.min.js"></script>
    <script src="Scripts/gsf.web.knockout.js"></script>
    <script>
        "use strict";

        // *** Sequence View Models ***

        var sequenceDomIndex = 0;

        var SequenceType = {
            Read: 0,
            Write: 1
        }

        var RecordType = {
            DiscreteInput: 0,
            Coil: 1,
            InputRegister: 2,
            HoldingRegister: 3,
            DerivedValue: 4
        }

        function getRecordTypeCode(recordType) {
            switch (recordType) {
                case RecordType.DiscreteInput:
                    return "DI";
                case RecordType.Coil:
                    return "CO";
                case RecordType.InputRegister:
                    return "IR";
                case RecordType.HoldingRegister:
                    return "HR";
                case RecordType.DerivedValue:
                    return "DV";
                default:
                    return "??";
            }
        }

        // Define view model for sequence records
        function RecordViewModel(parent, recordType, address, deserializedRecord) {
            const self = this;

            // Configuration fields
            self.parent = parent;

            // Observable fields
            self.recordType = ko.observable(recordType);
            self.selected = ko.observable(false);
            self.address = ko.observable(address);
            self.description = ko.observable("");
            self.dataValue = ko.observable();

            // If provided, construct from existing deserialized record
            if (deserializedRecord) {
                self.recordType(deserializedRecord.recordType);
                self.selected(deserializedRecord.selected);
                self.address(deserializedRecord.address);
                self.description(deserializedRecord.description);
                self.dataValue(deserializedRecord.dataValue);
            }

            // Setup address validation
            self.address.extend({ required: true });

            if (self.recordType() !== RecordType.DerivedValue)
                self.address.extend({ number: true }).extend({ min: 0 });

            self.addressValidation = ko.validatedObservable({ address: self.address });

            // Properties
            self.checkValidation = ko.pureComputed({
                read: function() {
                    if (!self.addressValidation.isValid() || isEmpty(self.address()))
                        return "has-error";

                    return undefined;
                },
                owner: self
            });

            self.groupIndex = ko.pureComputed({
                read: function() {
                    const groups = self.parent.sequenceGroups();
                    const recordIndex = self.parent.sequenceRecords().indexOf(self);

                    for (let i = 0; i < groups.length; i++) {
                        const group = groups[i];

                        if (recordIndex >= group.start && recordIndex <= group.stop)
                            return i;
                    }

                    return -1;
                },
                owner: self
            });

            self.groupCount = ko.pureComputed({
                read: function() {
                    const groupIndex = self.groupIndex();

                    if (groupIndex > -1) {
                        const group = self.parent.sequenceGroups()[groupIndex];
                        return (group.stop - group.start + 1);
                    }

                    return -1;
                },
                owner: self
            });

            self.isGroupFirst = ko.pureComputed({
                read: function() {
                    const groupIndex = self.groupIndex();

                    if (groupIndex > -1) {
                        const group = self.parent.sequenceGroups()[groupIndex];
                        return self.parent.sequenceRecords.indexOf(self) === group.start;
                    }

                    return false;
                },
                owner: self
            });

            self.isGroupLast = ko.pureComputed({
                read: function() {
                    const groupIndex = self.groupIndex();

                    if (groupIndex > -1) {
                        const group = self.parent.sequenceGroups()[groupIndex];
                        return self.parent.sequenceRecords.indexOf(self) === group.stop;
                    }

                    return false;
                },
                owner: self
            });

            self.groupBorders = ko.pureComputed({
                read: function() {
                    const records = self.parent.sequenceRecords();
                    const borderExpression = "\"border-{0}-color\": \"{1}\", \"border-{0}-style\": \"{2}\", \"border-{0}-width\": \"{3}\"";
                    const recordIndex = records.indexOf(self);
                    const style = "solid";
                    const width = "3px";
                    var color = "black";
                    var topWidth = width;
                    var bottomStyle = "none";

                    if (self.recordType() !== RecordType.DerivedValue && self.groupCount() > 100)
                        color = "yellow";

                    var topColor = color;

                    if (recordIndex > 0) {
                        const previous = records[recordIndex - 1];

                        if (previous.recordType() === self.recordType()) {
                            if (self.recordType() === RecordType.DerivedValue) {
                                topWidth = "1px";
                                topColor = "#ddd";
                            } else if ((isEmpty(previous.address()) && isEmpty(self.address())) || parseInt(previous.address()) + 1 === parseInt(self.address())) {
                                topWidth = "1px";
                                topColor = "#ddd";
                            }
                        }
                    }

                    if (recordIndex === records.length - 1) {
                        bottomStyle = "solid";
                    }

                    var borderStyles = "{ " + String.format(borderExpression, "top", topColor, style, topWidth);
                    borderStyles += ", " + String.format(borderExpression, "left", color, style, width);
                    borderStyles += ", " + String.format(borderExpression, "bottom", color, bottomStyle, width);
                    borderStyles += ", \"border-right-style\": \"none\" }";

                    return JSON.parse(borderStyles);
                },
                owner: self
            });

            self.isDuplicate = ko.pureComputed({
                read: function() {
                    const records = self.parent.sequenceRecords();
                    const recordIndex = records.indexOf(self);

                    if (self.recordType() === RecordType.DerivedValue) {
                        if (recordIndex < records.length - 1) {
                            const next = records[recordIndex + 1];

                            if (next.recordType() === self.recordType() && notNull(next.address()).toUpperCase() === notNull(self.address()).toUpperCase())
                                return true;
                        }

                        if (recordIndex > 0) {
                            const previous = records[recordIndex - 1];

                            if (previous.recordType() === self.recordType() && notNull(previous.address()).toUpperCase() === notNull(self.address()).toUpperCase())
                                return true;
                        }

                        return false;
                    }

                    if (recordIndex < records.length - 1) {
                        const next = records[recordIndex + 1];

                        if (self.recordType() === next.recordType() && parseInt(self.address()) === parseInt(next.address()))
                            return true;
                    }

                    if (recordIndex > 0) {
                        const previous = records[recordIndex - 1];

                        if (previous.recordType() === self.recordType() && parseInt(previous.address()) === parseInt(self.address()))
                            return true;
                    }

                    return false;
                },
                owner: self
            });
        }


        // Define view model for sequences
        function SequenceViewModel(sequenceType, domIndex, index, expanded) {
            const self = this;

            // Configuration fields
            self.sequenceType = sequenceType;
            self.domIndex = domIndex;

            // Observable fields
            self.index = ko.observable(index);
            self.sequenceName = ko.observable();
            self.sequenceRecords = ko.observableArray();
            self.expanded = ko.observable(expanded);

            // Properties
            self.selectedRecordCount = ko.pureComputed({
                read: function() {
                    const records = self.sequenceRecords();
                    var selectedCount = 0;

                    if (records) {
                        for (let i = 0; i < records.length; i++) {
                            if (records[i].selected())
                                selectedCount++;
                        }
                    }

                    return selectedCount;
                },
                owner: self
            }).extend({ notify: "always" });

            self.canAddDerivedValue = ko.pureComputed({
                read: function() {
                    return self.selectedRecordCount() > 0 && $("input[name=interpretAs" + self.domIndex + "]:checked").length > 0;
                },
                owner: self
            });

            self.sequenceTypeDescription = ko.pureComputed({
                read: function() {
                    return self.sequenceType === SequenceType.Read ? "Read" : "Write";
                },
                owner: self
            });

            self.sequenceGroups = ko.pureComputed({
                read: function() {
                    const records = self.sequenceRecords();
                    const groups = [];
                    var group = { start: 0, stop: -1, type: -1 };

                    if (records.length > 0) {
                        for (let i = 1; i < records.length; i++) {
                            const previous = records[i - 1];
                            const current = records[i];

                            if (current.recordType() !== previous.recordType()) {
                                group.stop = i - 1;
                                group.type = previous.recordType();
                                groups.push(group);
                                group = { start: i, stop: -1 };
                            } else if (current.recordType() !== RecordType.DerivedValue && !((isEmpty(current.address()) && isEmpty(previous.address())) || parseInt(current.address()) === parseInt(previous.address()) + 1)) {
                                group.stop = i - 1;
                                group.type = previous.recordType();
                                groups.push(group);
                                group = { start: i, stop: -1 };
                            }
                        }

                        group.stop = records.length - 1;
                        group.type = records[group.stop].recordType();
                        groups.push(group);
                    }

                    return groups;
                },
                owner: self
            });

            self.groupLengthWarning = ko.pureComputed({
                read: function() {
                    const groups = self.sequenceGroups();

                    for (let i = 0; i < groups.length; i++) {
                        const group = groups[i];

                        if (group.type !== RecordType.DerivedValue && group.stop - group.start + 1 > 100)
                            return true;
                    }

                    return false;
                },
                owner: self
            });

            // Methods
            self.addNewSequenceRecord = function(recordType, deserializedRecord, expand) {
                var address = "";

                if (!deserializedRecord && self.sequenceRecords().length > 0) {
                    const records = self.sequenceRecords();
                    let lastAddress = null;

                    for (let i = records.length - 1; i >= 0; i--) {
                        if (records[i].recordType() === recordType) {
                            lastAddress = records[i].address();
                            break;
                        }
                    }

                    if (isNumber(lastAddress))
                        address = parseInt(lastAddress) + 1;
                }


                self.sequenceRecords.push(new RecordViewModel(self, recordType, address, deserializedRecord));
                self.sortSequenceRecords();

                // Make sure sequence is expanded when adding a record
                if (expand)
                    $("#sequenceContent" + domIndex).collapse("show");
            }

            self.sortSequenceRecords = function() {
                // Keep sequence map sorted by record type, then address
                self.sequenceRecords.sort(function(a, b) {
                    const firstOrderSort = a.recordType() - b.recordType();

                    if (firstOrderSort !== 0)
                        return firstOrderSort;

                    var addra = a.address();
                    var addrb = b.address();

                    if (isEmpty(addra))
                        addra = 0;

                    if (isEmpty(addrb))
                        addrb = 0;

                    if (isNumber(addra) && isNumber(addrb))
                        return parseInt(addra) - parseInt(addrb);

                    addra = addra.toUpperCase();
                    addrb = addrb.toUpperCase();

                    return addra < addrb ? -1 : (addra > addrb ? 1 : 0);
                });
            }

            self.removeSequenceRecord = function(record) {
                self.sequenceRecords.remove(record);
            }

            self.refreshSequenceRecords = function() {
                // Sort and fully rerender sequence records upon request
                self.sortSequenceRecords();
                const records = self.sequenceRecords();

                self.sequenceRecords([]);
                self.sequenceRecords(records);
            }

            self.clearInterpretAsSelection = function() {
                $("input[name=interpretAs" + self.domIndex + "]").prop("checked", false);
            }

            self.interpretAsSelectionChanged = function() {
                self.sequenceRecords.valueHasMutated();
            }

            self.selectNone = function() {
                const records = self.sequenceRecords();

                if (records) {
                    for (let i = 0; i < records.length; i++)
                        records[i].selected(false);
                }
            }

            self.selectOne = function(selectedIndex) {
                const records = self.sequenceRecords();

                if (records) {
                    for (let i = 0; i < records.length; i++)
                        records[i].selected(i === selectedIndex);
                }
            }

            self.serializeSequence = function() {
                var records = [];

                // Only serializing recordType, address, description and dataValue
                self.sequenceRecords().
                    forEach(function(record) {
                        records.push({
                            recordType: record.recordType(),
                            address: record.address().toString(),
                            description: record.description(),
                            dataValue: record.dataValue()
                        });
                    });

                return {
                    type: self.sequenceType,
                    name: self.sequenceName(),
                    records: records
                };
            }
        }

        function addSequenceRecord(sequence, recordType) {
            if (recordType === RecordType.DerivedValue) {
                sequence.addNewSequenceRecord(null,
                    {
                        recordType: recordType,
                        selected: false,
                        address: getDerivedValueAddressExpression(sequence),
                        description: "",
                        dataValue: ""
                    },
                    true);
            } else {
                sequence.addNewSequenceRecord(recordType, null, true);
            }
        }

        function MapViewModel() {
            const self = this;

            // Observable fields
            self.sequences = ko.observableArray();
            self.unitID = ko.observable(255).extend({ required: true }).extend({ number: true }).extend({ min: 0 }).extend({ max: 255 });
            self.pollingRate = ko.observable(2000).extend({ required: true }).extend({ number: true }).extend({ min: 100 });
            self.interSequenceGroupPollDelay = ko.observable(250).extend({ required: true }).extend({ number: true }).extend({ min: 100 });
            self.ipPort = ko.observable(502).extend({ required: true }).extend({ number: true }).extend({ min: 1 }).extend({ max: 65535 });
            self.hostName = ko.observable("localhost").extend({ required: true });
            self.interface = ko.observable("0.0.0.0").extend({ required: true }).extend({ pattern: { message: 'Must be a valid IP address', params: /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/ } });
            self.comPort = ko.observable(1).extend({ required: true }).extend({ number: true }).extend({ min: 1 }).extend({ max: 65535 });
            self.dataBits = ko.observable(8).extend({ required: true }).extend({ number: true }).extend({ min: 5 }).extend({ max: 8 });

            // Internal fields
            self._isDirty = ko.observable(false);
            self._frameFormat = ko.observable("TCP");
            self._transport = ko.observable("TCP");
            self._connectionString = ko.observable("");

            // Properties
            self.isDirty = ko.pureComputed({
                read: self._isDirty,
                write: function(value) {
                    if (value === undefined)
                        value = true;

                    self._isDirty(value);
                },
                owner: self
            });

            self.frameFormat = ko.pureComputed({
                read: self._frameFormat,
                write: function(value) {
                    if (value === "TCP") {
                        if (self.transport() === "SERIAL")
                            self.transport("TCP");
                    } else {
                        if (self.transport() !== "SERIAL")
                            self.transport("SERIAL");
                    }

                    self._frameFormat(value);
                },
                owner: self
            });

            self.transport = ko.pureComputed({
                read: self._transport,
                write: function(value) {
                    if (value !== self._transport()) {
                        self._transport(value);
                        self.connectionString("");
                    }
                },
                owner: self
            });

            self.connectionString = ko.pureComputed({
                read: function() {
                    const parameters = notNull(self._connectionString()).parseKeyValuePairs();
                    parameters.set("frameFormat", self.frameFormat());
                    parameters.set("transport", self.transport());
                    parameters.set("unitID", self.unitID());
                    self._connectionString(parameters.joinKeyValuePairs());
                    return self._connectionString();
                },
                write: function(value) {
                    self._connectionString(value);
                },
                owner: self
            });

            self.totalSequenceGroups = ko.pureComputed({
                read: function() {
                    var total = 0;

                    for (let i = 0; i < self.sequences().length; i++)
                        total += self.sequences()[i].sequenceGroups().length;

                    return total;
                },
                owner: self
            });

            self.pollingRateWarning = ko.pureComputed({
                read: function() {
                    return self.totalSequenceGroups() * self.interSequenceGroupPollDelay() > self.pollingRate();
                },
                owner: self
            });

            // Methods
            self.addNewSequence = function(sequenceType, expanded) {
                const domIndex = sequenceDomIndex;
                const sequence = new SequenceViewModel(sequenceType, domIndex, self.sequences().length, expanded);

                self.sequences.push(sequence);

                sequenceDomIndex++;

                return sequence;
            }

            self.removeSequence = function(sequence) {
                if (sequence.sequenceRecords().length === 0 || confirm("Are you sure you want to delete sequence \"" + sequence.sequenceName() + "\"?")) {
                    const sequences = self.sequences();
                    const index = sequences.indexOf(sequence);

                    if (index !== -1)
                        sequences.splice(index, 1);

                    // Fully rerender reorderable sequences when one is removed
                    self.sequences([]);
                    self.sequences(sequences);

                    reorderSequencePanels();
                }
            }

            self.newSequenceMap = function() {
                self.sequences([]);
                self.isDirty(false);
            }

            self.loadSequenceMap = function(fileBlob, appendMode) {
                var reader = new FileReader();

                reader.onload = function() {
                    const data = JSON.parse(reader.result);

                    if (!appendMode)
                        self.sequences([]);

                    data.sequences.forEach(function(parsedSequence) {
                        var sequence = self.addNewSequence(parsedSequence.type, false);
                        sequence.sequenceName(parsedSequence.name);

                        // Restore full field set, only a partial set gets serialized
                        parsedSequence.records.forEach(function(record) {
                            sequence.addNewSequenceRecord(null,
                                {
                                    recordType: record.recordType,
                                    selected: false,
                                    address: record.address,
                                    description: record.description,
                                    dataValue: record.dataValue
                                },
                                false);
                        });
                    });

                    self.isDirty(appendMode);
                };

                reader.onloadend = function() {
                    if (reader.error && reader.error.message)
                        alert("Failed to load sequence file: " + reader.error.message);

                    loadMappingComplete();
                };

                reader.readAsText(fileBlob);
            }

            self.saveSequenceMap = function(fileName) {
                const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(self.serializeMapping(), null, 4));
                const anchor = $("#saveMappingFileLink");

                if (typeof anchor[0].download != "undefined") {
                    anchor.attr("href", data);
                    anchor.attr("download", fileName);
                    anchor[0].click();
                } else {
                    window.open(data, "_blank", "");
                }

                self.isDirty(false);
            }

            self.serializeMapping = function() {
                const sequences = self.sequences();
                var serializedSequences = [];

                if (sequences) {
                    sequences.forEach(function(sequence) {
                        serializedSequences.push(sequence.serializeSequence());
                    });
                }

                return {
                    sequences: serializedSequences
                };
            }
        }

        const viewModel = new MapViewModel();

        function getSequence(domIndex) {
            const sequences = viewModel.sequences();

            for (var i = 0; i < sequences.length; i++) {
                const sequence = sequences[i];

                if (sequence.domIndex === domIndex)
                    return sequence;
            }

            return null;
        }

        function interpretAsSelectionChanged(domIndex) {
            const sequence = getSequence(domIndex);

            if (!sequence)
                return;

            // Notify sequence view model that interpret-as selection has changed
            sequence.interpretAsSelectionChanged();

            // Auto-interpret selected record values as type
            // TODO: Call data-hub function to interpret selected values
        }

        function selectedSequenceRecordsChanged(domIndex, selectedIndex) {
            const sequence = getSequence(domIndex);

            if (!sequence)
                return;

            // Clear any selected interpret-as option
            sequence.clearInterpretAsSelection();

            // Wait a moment for ko processing to complete before validating selections
            setTimeout(function() {
                    validateSelections(sequence, selectedIndex);
            }, 250);
        }

        function validateSelections(sequence, selectedIndex) {
            const records = sequence.sequenceRecords();

            if (!records)
                return;

            // Validate selected record types match
            let firstSelectedType = null;
            let recordTypesMatch = true;

            for (let i = 0; i < records.length; i++) {
                if (records[i].selected()) {
                    if (firstSelectedType != null) {
                        if (firstSelectedType !== records[i].recordType()) {
                            recordTypesMatch = false;
                            break;
                        }
                    } else {
                        firstSelectedType = records[i].recordType();
                    }
                }
            }

            if (!recordTypesMatch) {
                if (records[selectedIndex].selected())
                    sequence.selectOne(selectedIndex);
                else
                    sequence.selectNone();
            }

            // Validate selected records are contiguous
            let lastSelectedIndex = null;
            let recordsAreContiguous = true;

            for (let i = 0; i < records.length; i++) {
                if (records[i].selected()) {
                    if (lastSelectedIndex != null) {
                        if (i !== lastSelectedIndex + 1) {
                            recordsAreContiguous = false;
                            break;
                        }
                    }

                    lastSelectedIndex = i;
                }
            }

            if (!recordsAreContiguous) {
                if (records[selectedIndex].selected())
                    sequence.selectOne(selectedIndex);
                else
                    sequence.selectNone();
            }
        }

        function getDerivedValueAddressExpression(sequence) {
            const records = sequence.sequenceRecords();

            if (!records)
                return "";

            let address = $("input[name='interpretAs" + sequence.domIndex + "']:checked").parent().text();

            if (isEmpty(address))
                return "";

            address += "(";

            let count = 0;

            for (let i = 0; i < records.length; i++) {
                if (records[i].selected()) {
                    if (count > 0)
                        address += ",";

                    address += getRecordTypeCode(records[i].recordType());
                    address += records[i].address();
                    count++;
                }
            }

            address += ")";

            return address;
        }

        function postSequenceRendering(elements, sequence) {
            // Call reorder sequence panels after any rendering to make sure
            // model index always matches visible sequence ordering
            reorderSequencePanels();

            const collapsableSection = $(elements).find("div.collapse");

            if (!collapsableSection)
                return;

            // Track current expanded state such that upon any
            // re-render, expanded state is maintained
            collapsableSection.on("shown.bs.collapse", function() {
                sequence.expanded(true);
            });

            collapsableSection.on("hidden.bs.collapse", function() {
                sequence.expanded(false);
            });

            $(elements).find("tbody").sortable({
                items: "tr",
                cursor: "move",
                opacity: 0.6
            }).disableSelection();
        }

        var sourceCheckbox = null;

        function postSequenceRecordRendering(elements, sequenceRecord) {
            const checkbox = $(elements).find("input[type=checkbox]");

            if (!checkbox)
                return;

            const sequenceContent = $("#sequenceContent" + sequenceRecord.parent.domIndex);

            if (!sequenceContent)
                return;

            const records = sequenceRecord.parent.sequenceRecords;
            const parentCell = checkbox.parents("td");

            // Make dragged checkbox mark all other checkboxes for easy mass selection
            checkbox.on("drag", function(event) {
                sourceCheckbox = event.target;
                parentCell.css("background-color", "lightgray");
                parentCell.css("border-style", "dashed");
                parentCell.css("border-top-width", "3px");
                parentCell.css("border-top-color", "black");
            });

            checkbox.on("dragover", function(event) {
                event.preventDefault();

                if (sourceCheckbox && event.target !== sourceCheckbox && !$(event.target).prop("disabled")) {
                    const index = $(event.target).parents("tr")[0].rowIndex - 1;
                    const record = records()[index];

                    if (record.recordType() !== RecordType.DerivedValue) {
                        record.selected(sourceCheckbox.checked);
                        validateSelections(sequenceRecord.parent, index);
                    }
                }
            });

            parentCell.on("dragover", function(event) {
                event.preventDefault();

                if (sourceCheckbox && event.target !== sourceCheckbox && !$(event.target).find("input[type=checkbox]").prop("disabled")) {
                    const index = $(event.target).parents("tr")[0].rowIndex - 1;
                    const record = records()[index];

                    if (record.recordType() !== RecordType.DerivedValue) {
                        record.selected(sourceCheckbox.checked);
                        validateSelections(sequenceRecord.parent, index);
                    }
                }
            });

            checkbox.on("dragend", function(event) {
                sourceCheckbox = null;
                parentCell.css("background-color", "");
                parentCell.css("border-style", "");
                parentCell.css("border-top-width", "");
                parentCell.css("border-top-color", "");
            });

            // Allow up/down arrow keys to change focus between each row's checkbox
            checkbox.keydown(function(event) {
                if (event.which === 38) {
                    // Arrow up
                    const previousIndex = records.indexOf(sequenceRecord) - 1;

                    if (previousIndex > -1) {
                        const previous = sequenceContent.find("input[type=checkbox]:eq(" + previousIndex + ")");

                        if (!$.isEmptyObject(previous))
                            previous.focus();
                    }

                } else if (event.which === 40) {
                    // Arrow down
                    const nextIndex = records.indexOf(sequenceRecord) + 1;

                    if (nextIndex < records().length) {
                        const next = sequenceContent.find("input[type=checkbox]:eq(" + nextIndex + ")");

                        if (!$.isEmptyObject(next))
                            next.focus();
                    }
                }
            });
        }

        // *** Sequence Reorder Handling ***

        function reorderSequencePanels(event, ui) {
            const sequencePanels = $("#sequencePanels");

            $(".panel", sequencePanels).each(function(index, elem) {
                const listItem = $(elem);
                const newIndex = listItem.index();
                const badges = listItem.find(".badge");

                if (badges.length > 0) {
                    // Update DOM section index
                    const indexBadge = $(badges[0]);
                    const oldIndex = parseInt(indexBadge.text()) - 1;

                    indexBadge.text(newIndex + 1);

                    const length = indexBadge.text().length;

                    if (length === 2)
                        indexBadge.css("margin-left", "-3px");

                    if (length > 2)
                        indexBadge.css("margin-left", "-6px");

                    // Update view model index
                    const sequence = viewModel.sequences()[oldIndex];

                    if (sequence)
                        sequence.index(newIndex);
                }
            });

            // Make sure view model is reordered to match user defined order
            viewModel.sequences().sort(function(a, b) {
                return a.index() - b.index();
            });
        }

        function moveSequenceUp(anchorElement) {
            const currentItem = $(anchorElement).parents("li");
            const index = currentItem.index();

            if (index < 1)
                return;

            currentItem.insertBefore($("#sequencePanels li:eq(" + (index - 1) + ")"));
            reorderSequencePanels();
        }

        function moveSequenceDown(anchorElement) {
            const currentItem = $(anchorElement).parents("li");
            const index = currentItem.index();

            if (index > $("#sequencePanels li").size() - 2)
                return;

            currentItem.insertAfter($("#sequencePanels li:eq(" + (index + 1) + ")"));
            reorderSequencePanels();
        }

        function expandAllSequences() {
            $("li.panel div.collapse").collapse("show");
        }

        function collapseAllSequences() {
            $("li.panel div.collapse").collapse("hide");
        }

        $(function() {
            ko.validation.rules.pattern.message = "Invalid";

            ko.validation.init({
                registerExtenders: true,
                messagesOnModified: true,
                insertMessages: true,
                parseInputAttributes: true,
                allowHtmlMessages: true,
                messageTemplate: null,
                decorateElement: true,
                errorElementClass: "has-error",
                errorMessageClass: "help-block",
                grouping: { deep: true, observable: true, live: true }
            }, true);

            // Handle special validation error message location when using bootstap add-on fields
            ko.bindingHandlers.validationCore = {
                init: function(element, valueAccessor, allBindingsAccessor, viewModel, bindingContext) {
                    const parent = $(element).parent().closest(".input-group");
                    const message = document.createElement("em");
                    message.className = "validationMessage small";

                    if (parent.length > 0)
                        $(parent).after(message);
                    else
                        $(element).after(message);

                    ko.applyBindingsToNode(message, { validationMessage: valueAccessor() });
                }
            };

            ko.bindingHandlers.applyVerticalText = {
                init: function(element, valueAccessor, allBindings, viewModel, bindingContext) {
                    $(element).text(ko.unwrap(valueAccessor()));
                },
                update: function(element, valueAccessor, allBindings, viewModel, bindingContext) {
                    // Adjust element height and width if element is visible
                    if (element.offsetParent !== null) {
                        element.style.height = element.offsetWidth + "px";
                        element.style.width = element.offsetHeight + "px";
                    }

                    $(element).text(ko.unwrap(valueAccessor()));

                    const length = $(element).text().length;

                    if (length === 2)
                        $(element).css("margin-top", "10px");

                    if (length > 2)
                        $(element).css("margin-top", "14px");

                }
            };

            ko.options.deferUpdates = true;

            // Initialize primary view model
            ko.applyBindings(viewModel);

            ko.watch(viewModel.sequences, { depth: -1 }, function(parents, child, item) {
                viewModel.isDirty(true);
            });

            // Initialize jQuery based sequence reordering
            $("#sequencePanels").sortable({
                handle: ".panel-heading",
                update: reorderSequencePanels
            });

            // Setup save mapping file name dialog functionality
            $("#saveMappingFile").click(function() {
                $("#saveMappingFileNameDialog").hide();

                var fileName = $("#inputMappingFileName").val();

                if (!fileName.endsWith(".json"))
                    fileName += ".json";

                viewModel.saveSequenceMap(fileName);
            });

            // Make enter key auto-click save
            $("#inputMappingFileName").keyup(function(event) {
                if (event.keyCode === 13)
                    $("#saveMappingFile").click();
            });

            // Auto-select all text on focus
            $("#inputMappingFileName").focus(function() {
                $(this).select();
            });

            // Prevent default form submission when user presses enter
            $("#saveMappingFileNameDialog").submit(function() {
                return false;
            });

            // Auto-hide pop-up form when user clicks outside form area
            $("#saveMappingFileNameDialog").focusout(function() {
                if (!$("#saveMappingFileNameDialog").is(":hover") && !$("#showSaveMappingFileNameDialog").is(":hover"))
                    $("#saveMappingFileNameDialog").hide();
            });

            dataHubClient.connectionStatusUpdate = function(message, color) {
                // Html encode message
                const encodedMessage = $("<div />").text(message).html();
                const connectionStatusWindow = $("#connectionStatusWindow");

                connectionStatusWindow.append("<span style='color: " + color + "'>" + encodedMessage + "</span><br/>");

                if (connectionStatusWindow[0].childElementCount > 50)
                    connectionStatusWindow.find(":first-child").remove();

                scrollConnectionStatusWindowToBottom();
            }

            dataHubClient.attemptingConnection = function() {
                $("#notConnected").hide();
                $("#connected").hide();
                $("#attemptingConnection").show();
            }

            dataHubClient.connectionSucceeded = function() {
                $("#notConnected").hide();
                $("#attemptingConnection").hide();
                $("#connected").show();
            }

            dataHubClient.connectionFailed = function() {
                $("#attemptingConnection").hide();
                $("#connected").hide();
                $("#notConnected").show();
                $("#connectionStatus").collapse("show");
            }

            $("#tcpBuilderDialog").modal({
                show: false,
                backdrop: "static",
                keyboard: false
            });

            $("#udpBuilderDialog").modal({
                show: false,
                backdrop: "static",
                keyboard: false
            });

            $("#serialBuilderDialog").modal({
                show: false,
                backdrop: "static",
                keyboard: false
            });
        });

        function scrollConnectionStatusWindowToBottom() {
            const connectionStatusWindow = $("#connectionStatusWindow");
            connectionStatusWindow.scrollTop(connectionStatusWindow[0].scrollHeight);
        }

        $(window).resize(function() {
            scrollConnectionStatusWindowToBottom();
        });

        $(window).on("onMessageVisibiltyChanged", function(event) {
            scrollConnectionStatusWindowToBottom();
        });

        var loadAppendMode = false;

        function createNewMappingFile() {
            if (viewModel.isDirty() && !confirm("Are you sure you want to lose unsaved changes to current mapping?"))
                return;

            viewModel.newSequenceMap();
        }

        function loadMappingFile(event) {
            $("#loadingMappingMessage").show();

            const files = event.target.files;

            if (loadAppendMode) {

                for (let i = 0; i < files.length; i++) {
                    viewModel.loadSequenceMap(files[i], loadAppendMode);
                }
            } else {
                viewModel.loadSequenceMap(files[0], loadAppendMode);

                if (files.length > 1)
                    showInfoMessage("Only loaded first file from the selected set. Use \"Append Mapping\" to load multiple mappings into the current configuration.", -1);
            }

            $("#loadMappingFileName").val("");
        }

        function loadMappingComplete() {
            $("#loadingMappingMessage").hide();
        }

        function showLoadMappingFileNameDialog(appendMode) {
            if (!appendMode && viewModel.isDirty() && !confirm("Are you sure you want to lose unsaved changes to current mapping?"))
                return;

            loadAppendMode = appendMode;
            $("#loadMappingFileName").trigger("click");
        }

        function showSaveMappingFileNameDialog() {
            $("#saveMappingFileNameDialog").toggle();

            if ($("#saveMappingFileNameDialog").is(":visible"))
                $("#inputMappingFileName").focus();
        }

        function showConnectionBuilderDialog() {
            switch (viewModel.transport()) {
                case "TCP":
                    $("#tcpBuilderDialog").show();
                    $("#inputTcpHostName").focus();
                    break;
                case "UDP":
                    $("#udpBuilderDialog").show();
                    $("#inputUdpPort").focus();
                    break;
                case "SERIAL":
                    $("#serialBuilderDialog").show();
                    $("#inputSerialPort").focus();
                    break;
            }
        }

        function applyTcpConnectionSettings() {
            viewModel.connectionString(String.format("hostName = {0}; port = {1}", $("#inputTcpHostName").val(), $("#inputTcpPort").val()));
            $('#tcpBuilderDialog').hide();
        }

        function applyUdpConnectionSettings() {
            viewModel.connectionString(String.format("port = {0}; interface = {1}", $("#inputUdpPort").val(), $("#inputUdpInterface").val()));
            $('#udpBuilderDialog').hide();
        }

        function applySerialConnectionSettings() {
            viewModel.connectionString(String.format("portName = COM{0}; baudRate = {1}; dataBits = {2}; parity = {3}; stopBits = {4}", $("#inputSerialPort").val(), $("#selectSerialBaudRate").val(), $("#inputSerialDataBits").val(), $("#selectSerialParity").val(), $("#selectSerialStopBits").val()));
            $('#serialBuilderDialog').hide();
        }

        function connectToDevice() {
            $("#connectionStatus").collapse("hide");

            if (hubIsConnected) {
                dataHub.modbusConnect($("#inputConnectionString").val()).done(function (success) {
                    console.log("connect returned: " + success);
                });
            }
        }
    </script>
}
<h3>Modbus Configuration Map Builder</h3>
@* Connection Settings and Status Panel *@
<div class="panel panel-primary">
    <div class="panel-heading clearfix">
        <label>
            Modbus&nbsp;Device Connection&nbsp;Settings
        </label>
        <div class="pull-right">
            <span id="notConnected">Not&nbsp;Connected&nbsp;&nbsp;<span class="glyphicon glyphicon-ban-circle" style="color: #FF003B;"></span></span>&nbsp;&nbsp;
            <span id="attemptingConnection" style="display: none">Attempting&nbsp;Connection&nbsp;&nbsp;<span class="glyphicon glyphicon-refresh glyphicon-spin" style="color: yellow"></span></span>&nbsp;&nbsp;
            <span id="connected" style="display: none">Connected&nbsp;&nbsp;<span class="glyphicon glyphicon-check" style="color: chartreuse"></span></span>
            <button type="button" class="btn btn-xs btn-collapsable" data-toggle="collapse" data-target="#connectionSettings"></button>
        </div>
    </div>
    <div class="panel-body collapse in" id="connectionSettings">
        <form class="form-hortizontal" role="form">
            <div class="row">
                <div class="form-group">
                    <label class="col-md-2 control-label top-padding text-right text-nowrap" for="selectFrameFormat">Frame Format:</label>
                    <div class="col-md-2">
                        <select class="form-control" id="selectFrameFormat" data-bind="value: frameFormat">
                            <option value="RTU">RTU</option>
                            <option value="ASCII">ASCII</option>
                            <option value="TCP">TCP</option>
                        </select>
                    </div>
                    <label class="col-md-2 control-label top-padding text-right text-nowrap" for="selectTransport">Transport:</label>
                    <div class="col-md-2">
                        <select class="form-control" id="selectTransport" data-bind="value: transport">
                            <option value="TCP" data-bind="attr: { 'disabled': frameFormat() != 'TCP' }">TCP</option>
                            <option value="UDP" data-bind="attr: { 'disabled': frameFormat() != 'TCP' }">UDP</option>
                            <option value="SERIAL" data-bind="attr: { 'disabled': frameFormat() == 'TCP' }">Serial</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="padding-top: 0; margin-top: -15px;" data-bind="validationElement: unitID">
                    <label class="col-md-2 control-label top-padding text-right text-nowrap" for="inputUnitID">Unit ID:</label>
                    <div class="col-md-2">
                        <input type="number" class="form-control" id="inputUnitID" data-bind="integer, textInput: unitID">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="form-group">
                    <label class="col-md-2 control-label top-padding text-right text-nowrap" for="inputConnectionString">Connection String:</label>
                    <div class="col-md-10">
                        <div class="input-group">
                            <input type="text" class="form-control" id="inputConnectionString" data-bind="textInput: connectionString">
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-default" onclick="showConnectionBuilderDialog()"><span class="glyphicon glyphicon-edit glyphicon-action-button"></span> Build...</button>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="form-group" data-bind="validationElement: pollingRate, css: { 'has-warning': pollingRateWarning }">
                    <label class="col-md-2 control-label top-padding text-right text-nowrap" for="inputPollingRate">Polling Rate:</label>
                    <div class="col-md-2">
                        <div class="input-group">
                            <input type="number" class="form-control" placeholder="Polling rate..." id="inputPollingRate" data-bind="integer, textInput: pollingRate" required>
                            <span class="input-group-addon">ms</span>
                        </div>
                    </div>
                </div>
                <div class="form-group" style="padding-top: 0; margin-top: -15px;" data-bind="validationElement: interSequenceGroupPollDelay">
                    <label class="col-md-2 control-label text-right" for="inputInterSequenceGroupDelay">Inter-Sequence Group&nbsp;Poll&nbsp;Delay:</label>
                    <div class="col-md-2">
                        <div class="input-group">
                            <input type="number" class="form-control" placeholder="Poll delay..." id="inputInterSequenceGroupDelay" data-bind="integer, textInput: interSequenceGroupPollDelay" required>
                            <span class="input-group-addon">ms</span>
                        </div>
                    </div>
                    <div class="col-md-4 top-padding">
                        <button type="button" class="btn btn-primary pull-right" onclick="connectToDevice()" hub-dependent><strong>Connect</strong>&nbsp;</button>
                    </div>
                </div>
            </div>
        </form>
        <div class="panel panel-default">
            <div class="panel-heading" style="height: 30px; padding-top: 5px">
                <label>Connection&nbsp;Status</label>
                <button type="button" class="btn btn-xs btn-collapsable collapsed" style="top: 0; right: -10px" data-toggle="collapse" data-target="#connectionStatus"></button>
            </div>
            <div class="panel-body collapse" style="padding: 2px" id="connectionStatus">
                <pre id="connectionStatusWindow" class="small connection-status" style="height: 150px"></pre>
            </div>
        </div>
    </div>
</div>
@* Primary Buttons Panel *@
<div class="panel panel-default">
    <div class="panel-body clearfix" style="padding-top: 5px; padding-bottom: 10px">
        <button type="button" class="btn btn-default top-margin" style="margin-left: -5px" title="Add New Modbus Read Sequence to Current Mapping" data-bind="click: addNewSequence.bind($data, SequenceType.Read, true)"><span class="glyphicon glyphicon-plus-sign glyphicon-action-button"></span> Read Sequence</button>
        <button type="button" class="btn btn-default top-margin" title="Add New Modbus Write Sequence to Current Mapping" data-bind="click: addNewSequence.bind($data, SequenceType.Write, true)"><span class="glyphicon glyphicon-plus-sign glyphicon-action-button"></span> Write Sequence</button>
        <div class="top-padding pull-right">
            <button type="button" class="btn btn-default" title="Create a New Modbus Sequence Mapping" onclick="createNewMappingFile()"><span class="glyphicon glyphicon-circle-arrow-down glyphicon-action-button"></span> New Mapping</button>
            <button type="button" class="btn btn-default" title="Load Existing Modbus Sequence Mapping" onclick="showLoadMappingFileNameDialog(false)"><span class="glyphicon glyphicon-floppy-open glyphicon-action-button"></span> Load Mapping</button>
            <input id="loadMappingFileName" type="file" accept="text/json" style="position: fixed; top: -100em" onchange="loadMappingFile(event)" multiple>
            <button type="button" class="btn btn-default" title="Save Current Modbus Sequence Mapping" onclick="showSaveMappingFileNameDialog()" id="showSaveMappingFileNameDialog" data-bind="enable: isDirty"><span class="glyphicon glyphicon-floppy-save glyphicon-action-button"></span> Save Mapping</button>
            <div class="well well-sm floating-form" id="saveMappingFileNameDialog" style="z-index: 1000">
                <form class="form-inline" role="form">
                    <div class="form-group form-group-sm">
                        <button type="button" class="close" onclick="$('#saveMappingFileNameDialog').hide()" style="margin-top: -13px; margin-left: 8px">&times;</button>
                        <label for="inputMappingFileName">Mapping file name:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="inputMappingFileName" placeholder="File name..." />
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-default btn-sm" id="saveMappingFile" style="margin-right: -3px; font-weight: bold">Save</button>
                            </span>
                        </div>
                    </div>
                </form>
            </div>
            <a href="#" id="saveMappingFileLink" target="_blank" style="display: none"></a>
            <button type="button" class="btn btn-default" style="margin-right: -5px" title="Load Modbus Sequence Mapping and Append to Current Mapping" onclick="showLoadMappingFileNameDialog(true)"><span class="glyphicon glyphicon-import glyphicon-action-button"></span> Append Mapping</button>
        </div>
    </div>
</div>
<div id="loadingMappingMessage" class="top-margin bottom-margin clearfix" style="display: none">
    <div class="pull-right" style="font-weight: bold">
        Loading&nbsp;&nbsp;<span class="glyphicon glyphicon-refresh glyphicon-spin"></span>
    </div>
</div>
@* Reorderable Mapping Sequences Panel *@
<button type="button" class="btn btn-xs btn-collapsable" onclick="collapseAllSequences()" title="Collapse All Sequences" style="top: 3px; right: 0"></button>
<button type="button" class="btn btn-xs btn-collapsable collapsed" onclick="expandAllSequences()" title="Expand All Sequences" style="top: 3px; right: 2px; margin-left: 5px"></button>
<hr class="thick-spacer" />
<div class="warning-message" data-bind="visible: pollingRateWarning">Warning: minimum total read time for all sequence groups exceeds defined polling rate.</div>
<div class="sequence-records-message">Total Sequences: <span data-bind="text: sequences().length"></span> <span style="padding-left: 25px">Total Sequence Groups: <span data-bind="text: totalSequenceGroups()"></span></span><span style="padding-left: 25px">Minimum Total Read Time: <span data-bind="text: totalSequenceGroups() * interSequenceGroupPollDelay(), style: { 'color': pollingRateWarning() ? 'red' : undefined }"></span> ms</span></div>
<ul id="sequencePanels" class="list-unstyled" data-bind="foreach: { data: sequences, afterRender: postSequenceRendering }">
    <li class="panel" data-bind="css: { '@ReadSequencePanelType': sequenceType === SequenceType.Read, '@WriteSequencePanelType': sequenceType === SequenceType.Write }">
        <div class="panel-heading clearfix">
            <form class="form-inline form-inline-sequence" role="form">
                <div class="form-group" data-bind="css: {'has-error': isEmpty(sequenceName()), 'has-feedback': isEmpty(sequenceName())}">
                    <label data-bind="attr: { 'for': 'sequenceName' + domIndex }">
                        <a class="move-sequence-up" title="Move Sequence Order Up" onclick="moveSequenceUp(this)"><span class="glyphicon glyphicon-menu-up"></span></a>
                        <span class="badge"></span>&nbsp;&nbsp;<span data-bind="text: sequenceTypeDescription"></span> Sequence:
                        <span class="sequence-record-count"><span data-bind="text: 'Record&nbsp;Count:&nbsp;' + sequenceRecords().length"></span></span>
                        <a class="move-sequence-down" title="Move Sequence Order Down" onclick="moveSequenceDown(this)"><span class="glyphicon glyphicon-menu-down"></span></a>
                    </label>
                    <input type="text" class="form-control sequence-name" style="padding-right: 0" placeholder="Sequence name..." data-bind="textInput: sequenceName, attr: { 'id': 'sequenceName' + domIndex }">
                </div>
                <div class="form-group pull-right">
                    <button type="button" class="btn btn-default" title="Add New Modbus Discrete Input Record to Sequence" data-bind="click: addSequenceRecord.bind($data, $data, RecordType.DiscreteInput), visible: sequenceType === SequenceType.Read"><span class="glyphicon glyphicon-plus-sign glyphicon-action-button"></span> Discrete Input</button>
                    <button type="button" class="btn btn-default" title="Add New Modbus Coil Record to Sequence" data-bind="click: addSequenceRecord.bind($data, $data, RecordType.Coil)"><span class="glyphicon glyphicon-plus-sign glyphicon-action-button"></span> Coil</button>
                    <button type="button" class="btn btn-default" title="Add New Modbus Input Register Record to Sequence" data-bind="click: addSequenceRecord.bind($data, $data, RecordType.InputRegister), visible: sequenceType === SequenceType.Read"><span class="glyphicon glyphicon-plus-sign glyphicon-action-button"></span> Input Register</button>
                    <button type="button" class="btn btn-default" title="Add New Modbus Holding Register Record to Sequence" data-bind="click: addSequenceRecord.bind($data, $data, RecordType.HoldingRegister)"><span class="glyphicon glyphicon-plus-sign glyphicon-action-button"></span> Holding Register</button>
                    &nbsp;
                    <button type="button" class="btn btn-default" style="margin-right: -10px" title="Delete Sequence" data-bind="click: $root.removeSequence.bind($data)"><span class="glyphicon glyphicon-remove-circle glyphicon-delete-sequence"></span></button>
                    <button type="button" class="btn btn-xs btn-collapsable" data-toggle="collapse" data-bind="css: { 'collapsed': !expanded() }, attr: { 'data-target': '#sequenceContent' + domIndex }"></button>
                    @*<span class="model-index" data-bind="text: index"></span>*@
                </div>
            </form>
        </div>
        <div class="collapse" data-bind="css: { 'in': expanded }, attr: { 'id': 'sequenceContent' + domIndex }">
            <div class="panel-body" data-bind="css: { 'warning-border': groupLengthWarning }">
                <button type="button" class="btn btn-default btn-xs pull-right" style="margin-top: -10px; margin-right: -10px" title="Resort Sequence Records" data-bind="click: refreshSequenceRecords.bind($data)"><span class="glyphicon glyphicon-sort-by-attributes"></span></button>
                <div class="warning-message" data-bind="visible: groupLengthWarning">Warning: devices may not respond to reading or writing more than 100 registers in a single sequence group.</div>
                <div class="sequence-records-message">Sequence Groups: <span data-bind="text: sequenceGroups().length"></span><span style="padding-left: 25px">Minimum Read Time: <span data-bind="text: sequenceGroups().length * $parent.interSequenceGroupPollDelay()"></span> ms</span></div>
                <div class="table-responsive">
                    <table class="table table-hover table-striped table-condensed">
                        <thead>
                            <tr>
                                <th style="text-align: center">Type</th>
                                <th data-bind="if: sequenceType === SequenceType.Read"></th>
                                <th>Address</th>
                                <th>Description</th>
                                <th data-bind="text: sequenceType === SequenceType.Read ? 'Current Value' : 'Value'"></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody data-bind="foreach: { data: sequenceRecords, afterRender: postSequenceRecordRendering }">
                            <tr style="cursor: move" , data-bind="style: { backgroundColor:  isDuplicate() ? 'yellow' : undefined }">
                                <td style="text-align: center; vertical-align: middle" width="5%" data-bind="style: groupBorders()"><div data-bind="if: isGroupFirst"><span class="sequence-group-count" data-bind="applyVerticalText: groupCount"></span></div><span data-bind="text: getRecordTypeCode(recordType())"></span></td>
                                <td style="text-align: center; vertical-align: middle" width="5%" data-bind="if: $parent.sequenceType === SequenceType.Read">
                                    <input type="checkbox" draggable="true" data-bind="checked: selected, visible: recordType() === RecordType.InputRegister || recordType() === RecordType.HoldingRegister, enable: !isEmpty(address()), attr: { 'onclick': 'selectedSequenceRecordsChanged(' + $parent.domIndex + ', ' + $index() + ')' }">
                                </td>
                                <td width="20%">
                                    <div class="form-group" style="padding: 0; margin: 0" data-bind="validationElement: address, css: checkValidation()">
                                        <input class="form-control" data-bind="textInput: address, attr: { 'type': recordType() == RecordType.DerivedValue ? 'text' : 'number', 'placeholder': recordType() == RecordType.DerivedValue ? undefined : 'Number...' }" required>
                                    </div>
                                </td>
                                <td data-bind="attr: { 'width': $parent.sequenceType === SequenceType.Read ? '45%' : '50%' }">
                                    <input type="text" class="form-control" placeholder="Description..." data-bind="textInput: description">
                                </td>
                                <td width="20%">
                                    <span data-bind="if: $parent.sequenceType === SequenceType.Write"><input type="number" class="form-control" placeholder="New value..." data-bind="integer, textInput: dataValue"></span>
                                    <span data-bind="if: $parent.sequenceType === SequenceType.Read"><input type="number" class="form-control" data-bind="value: dataValue" readonly></span>
                                </td>
                                <td style="text-align: center" width="5%">
                                    <button type="button" class="btn btn-default" title="Delete Sequence Record" data-bind="click: $parent.removeSequenceRecord"><span class="glyphicon glyphicon-remove-circle glyphicon-delete-sequence"></span></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="panel-footer" style="padding-top: 10px; padding-bottom: 1px" data-bind="if: sequenceType === SequenceType.Read">
                <span class="text-nowrap" style="margin-left: 5px; font-style: italic"><span data-bind="text: selectedRecordCount"></span> selected, interpret as:</span>
                <div class="form-group">
                    <span class="glyphicon glyphicon-menu-left glyphicon-interpret-type"></span>
                    <label class="radio-inline text-nowrap" data-bind="css: { disabled: selectedRecordCount() === 0 }"><input type="radio" data-bind="attr: { 'name': 'interpretAs' + domIndex, 'onclick': 'interpretAsSelectionChanged(' + domIndex + ')' }, enable: selectedRecordCount() > 0">String</label>
                    <label class="radio-inline text-nowrap" data-bind="css: { disabled: selectedRecordCount() !== 2 }"><input type="radio" data-bind="attr: { 'name': 'interpretAs' + domIndex, 'onclick': 'interpretAsSelectionChanged(' + domIndex + ')' }, enable: selectedRecordCount() === 2">Single</label>
                    <label class="radio-inline text-nowrap" data-bind="css: { disabled: selectedRecordCount() !== 4 }"><input type="radio" data-bind="attr: { 'name': 'interpretAs' + domIndex, 'onclick': 'interpretAsSelectionChanged(' + domIndex + ')' }, enable: selectedRecordCount() === 4">Double</label>
                    <label class="radio-inline text-nowrap" data-bind="css: { disabled: selectedRecordCount() !== 2 }"><input type="radio" data-bind="attr: { 'name': 'interpretAs' + domIndex, 'onclick': 'interpretAsSelectionChanged(' + domIndex + ')' }, enable: selectedRecordCount() === 2">Int32</label>
                    <label class="radio-inline text-nowrap" data-bind="css: { disabled: selectedRecordCount() !== 2 }"><input type="radio" data-bind="attr: { 'name': 'interpretAs' + domIndex, 'onclick': 'interpretAsSelectionChanged(' + domIndex + ')' }, enable: selectedRecordCount() === 2">UInt32</label>
                    <label class="radio-inline text-nowrap" data-bind="css: { disabled: selectedRecordCount() !== 4 }"><input type="radio" data-bind="attr: { 'name': 'interpretAs' + domIndex, 'onclick': 'interpretAsSelectionChanged(' + domIndex + ')' }, enable: selectedRecordCount() === 4">Int64</label>
                    <label class="radio-inline text-nowrap" data-bind="css: { disabled: selectedRecordCount() !== 4 }"><input type="radio" data-bind="attr: { 'name': 'interpretAs' + domIndex, 'onclick': 'interpretAsSelectionChanged(' + domIndex + ')' }, enable: selectedRecordCount() === 4">UInt64</label>
                    <span class="text-nowrap">
                        <span class="glyphicon glyphicon-menu-right glyphicon-interpret-type"></span>
                        <span class="glyphicon glyphicon-upload glyphicon-rotate-90 glyphicon-interpret-result"></span>
                    </span>
                    &nbsp;&nbsp;
                </div>
                <form class="form-inline form-inline-sequence" role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" data-bind="value: getDerivedValueAddressExpression($data), attr: { 'name': 'derivedValueExpression' + domIndex }" />
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Interpreted value..." readonly />
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-default" title="Add Derived Value as a New Record in Sequence" data-bind="click: addSequenceRecord.bind($data, $data, RecordType.DerivedValue), enable: canAddDerivedValue()"><span class="glyphicon glyphicon-plus-sign glyphicon-action-button"></span> Derived Value</button>
                            </span>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </li>
</ul>
@* JSON Sequences Display Panel *@
<hr class="thick-spacer" data-bind="visible: sequences().length > 0" />
<div class="panel panel-default">
    <div class="panel-heading" style="height: 30px; padding-top: 5px">
        <label>Serialized&nbsp;Sequences</label>
        <button type="button" class="btn btn-xs btn-collapsable collapsed" style="top: 0; right: -10px" data-toggle="collapse" data-target="#serializedSequences"></button>
    </div>
    <div class="panel-body collapse" style="padding: 2px; margin-bottom: -10px" id="serializedSequences">
        <pre data-bind="text: JSON.stringify(serializeMapping(), null, 4)"></pre>
    </div>
</div>
@* TCP Connection String Builder *@
<div id="tcpBuilderDialog" class="modal" role="dialog">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" onclick="$('#tcpBuilderDialog').hide()">&times;</button>
                <h4 class="modal-title">Define TCP Connection Parameters</h4>
            </div>
            <div class="modal-body">
                <form role="form">
                    <div class="form-group" data-bind="validationElement: hostName">
                        <label for="inputTcpHostName">Host Name or IP:</label>
                        <input type="text" class="form-control" id="inputTcpHostName" maxlength="200" size="200" data-bind="textInput: hostName">
                    </div>
                    <div class="form-group" data-bind="validationElement: ipPort">
                        <label for="inputTcpPort">Port:</label>
                        <input type="number" class="form-control" id="inputTcpPort" maxlength="5" size="5" data-bind="integer, textInput: ipPort">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary" onclick="applyTcpConnectionSettings()">Save</button>
                <button type="button" class="btn btn-default" onclick="$('#tcpBuilderDialog').hide()">Cancel</button>
            </div>
        </div>
    </div>
</div>
@* UDP Connection String Builder *@
<div id="udpBuilderDialog" class="modal" role="dialog">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" onclick="$('#udpBuilderDialog').hide()">&times;</button>
                <h4 class="modal-title">Define UDP Connection Parameters</h4>
            </div>
            <div class="modal-body">
                <form role="form">
                    <div class="form-group" data-bind="validationElement: ipPort">
                        <label for="inputUdpPort">Port:</label>
                        <input type="number" class="form-control" id="inputUdpPort" maxlength="5" size="5" data-bind="integer, textInput: ipPort">
                    </div>
                    <div class="form-group" data-bind="validationElement: interface">
                        <label for="inputUdpInterface">Interface IP:</label>
                        <input type="text" class="form-control" id="inputUdpInterface" maxlength="200" size="200" data-bind="textInput: interface">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary" onclick="applyUdpConnectionSettings()">Save</button>
                <button type="button" class="btn btn-default" onclick="$('#udpBuilderDialog').hide()">Cancel</button>
            </div>
        </div>
    </div>
</div>
@* Serial Connection String Builder *@
<div id="serialBuilderDialog" class="modal" role="dialog">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" onclick="$('#serialBuilderDialog').hide()">&times;</button>
                <h4 class="modal-title">Define Serial Connection Parameters</h4>
            </div>
            <div class="modal-body">
                <form role="form">
                    <div class="form-group" data-bind="validationElement: comPort">
                        <label for="inputSerialPort">Port:</label>
                        <div class="input-group">
                            <span class="input-group-addon">COM</span>
                            <input type="number" class="form-control" id="inputSerialPort" maxlength="5" size="5" data-bind="integer, textInput: comPort">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="selectSerialBaudRate">Baud Rate:</label>
                        <select class="form-control" id="selectSerialBaudRate">
                            <option value="115200">115200</option>
                            <option value="57600" selected>57600</option>
                            <option value="38400">38400</option>
                            <option value="19200">19200</option>
                            <option value="9600">9600</option>
                            <option value="4800">4800</option>
                            <option value="2400">2400</option>
                            <option value="1200">1200</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="selectSerialParity">Parity:</label>
                        <select class="form-control" id="selectSerialParity">
                            <option value="None" selected>None</option>
                            <option value="Odd">Odd</option>
                            <option value="Even">Even</option>
                            <option value="Mark">Mark</option>
                            <option value="Space">Space</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="selectSerialStopBits">Stop Bits:</label>
                        <select class="form-control" id="selectSerialStopBits">
                            <option value="One" selected>One</option>
                            <option value="Two">Two</option>
                            <option value="OnePointFive">OnePointFive</option>
                        </select>
                    </div>
                    <div class="form-group" data-bind="validationElement: dataBits">
                        <label for="inputSerialDataBits">Data Bits:</label>
                        <input type="number" class="form-control" id="inputSerialDataBits" maxlength="200" size="200" data-bind="integer, textInput: dataBits">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary" onclick="applySerialConnectionSettings()">Save</button>
                <button type="button" class="btn btn-default" onclick="$('#serialBuilderDialog').hide()">Cancel</button>
            </div>
        </div>
    </div>
</div>